# 預約功能使用說明

## 功能概述

當您使用預約功能時，系統會**自動將預約資料寫入資料庫**。整個流程如下：

## 使用流程

### 1. 填寫預約表單

訪問預約頁面：`http://localhost:5000/appointment`

填寫以下必填資訊：
- ✅ 病患姓名
- ✅ 聯絡電話
- ✅ 科別
- ✅ 醫師姓名
- ✅ 預約日期（必須是明天或之後）
- ✅ 預約時間

### 2. 提交表單

點擊「提交預約」按鈕後，系統會：

1. **驗證資料**
   - 檢查所有必填欄位是否已填寫
   - 驗證電話號碼格式
   - 驗證預約日期是否為未來日期

2. **連接資料庫**
   - 自動連接到 MySQL 資料庫
   - 如果連接失敗，會顯示錯誤訊息

3. **寫入資料庫**
   - 執行 INSERT 操作
   - 將預約資料寫入 `medical_appointments` 資料表
   - 自動提交事務（commit）

4. **驗證寫入**
   - 查詢剛插入的記錄
   - 確認資料已成功保存

5. **顯示結果**
   - 如果成功：跳轉到「我的預約」頁面，顯示成功訊息
   - 如果失敗：顯示錯誤訊息，保留表單資料

## 資料庫寫入詳情

### 寫入的資料欄位

| 欄位 | 說明 | 來源 |
|------|------|------|
| `username` | 使用者帳號 | 從登入 session 自動獲取 |
| `patient_name` | 病患姓名 | 表單輸入 |
| `patient_phone` | 聯絡電話 | 表單輸入 |
| `department` | 科別 | 表單選擇 |
| `doctor_name` | 醫師姓名 | 表單輸入 |
| `appointment_date` | 預約日期 | 表單輸入 |
| `appointment_time` | 預約時間 | 表單輸入 |
| `symptoms` | 症狀描述 | NULL（已移除） |
| `status` | 預約狀態 | 自動設為 'pending' |
| `created_at` | 建立時間 | 自動記錄 |
| `updated_at` | 更新時間 | 自動記錄 |

### 日誌輸出

當預約成功時，應用程式會輸出以下日誌：

```
[預約] 開始寫入資料庫 - 用戶: admin, 病患: 張三, 科別: 內科, 醫師: 李醫師, 日期: 2024-01-15, 時間: 10:00
[成功] 預約資料已成功寫入資料庫，預約ID: 1
[詳細] 預約資訊 - ID: 1, 用戶: admin, 病患: 張三, 電話: 0912345678, 科別: 內科, 醫師: 李醫師, 日期時間: 2024-01-15 10:00
[驗證] 資料已確認存在於資料庫中
```

## 確認資料已寫入

### 方法 1：查看預約列表

提交預約後，系統會自動跳轉到「我的預約」頁面，您可以在那裡看到剛創建的預約記錄。

### 方法 2：查看應用程式日誌

查看終端機輸出，如果看到 `[成功] 預約資料已成功寫入資料庫`，表示寫入成功。

### 方法 3：直接查詢資料庫

登入 MySQL 並執行：

```sql
USE medical_db;
SELECT * FROM medical_appointments ORDER BY created_at DESC LIMIT 5;
```

## 錯誤處理

如果寫入失敗，系統會：

1. **顯示錯誤訊息**
   - 在預約頁面顯示具體的錯誤原因
   - 保留已填寫的表單資料

2. **記錄詳細日誌**
   - 記錄錯誤代碼和錯誤訊息
   - 記錄嘗試寫入的資料

3. **自動回滾**
   - 如果發生錯誤，自動回滾事務
   - 確保資料庫狀態一致

## 常見問題

### Q: 提交後沒有跳轉到預約列表？

**A:** 可能是資料庫寫入失敗。請：
1. 查看應用程式日誌中的錯誤訊息
2. 執行 `python 測試資料庫寫入.py` 來診斷問題
3. 檢查資料庫連接配置

### Q: 如何確認資料已寫入？

**A:** 有幾種方法：
1. 查看「我的預約」頁面
2. 查看應用程式日誌
3. 直接查詢資料庫

### Q: 寫入失敗怎麼辦？

**A:** 請：
1. 查看錯誤訊息
2. 執行 `python 測試資料庫寫入.py` 診斷問題
3. 檢查資料庫服務是否運行
4. 檢查資料庫配置是否正確

## 技術細節

### 事務處理

系統使用資料庫事務來確保資料一致性：
- 如果寫入成功：自動提交（commit）
- 如果發生錯誤：自動回滾（rollback）

### 資料驗證

寫入後會立即驗證：
- 查詢剛插入的記錄
- 確認記錄存在
- 如果驗證失敗，會回滾並報告錯誤

### 錯誤代碼

常見的錯誤代碼：
- `1146`: 資料表不存在
- `1045`: 認證失敗
- `2003`: 無法連接資料庫
- `1049`: 資料庫不存在

## 總結

預約功能已經完全整合了資料庫寫入功能。當您提交預約表單時，系統會：

✅ 自動驗證資料  
✅ 自動連接資料庫  
✅ 自動寫入資料  
✅ 自動驗證寫入結果  
✅ 自動顯示成功或錯誤訊息  

您無需手動操作資料庫，所有操作都是自動完成的！

