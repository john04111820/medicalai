<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>語音助理介面</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>

    <!-- === 右上角導覽列 === -->
    <div class="top-right-nav">
        {% if username %}
            <!-- 有登入：顯示名字 + 登出按鈕 -->
            <span class="user-welcome">嗨，{{ username }}</span>
            <a href="/logout" class="nav-btn logout-btn">登出</a>
        {% else %}
            <!-- 沒登入：顯示登入按鈕，連結指向 /login -->
            <a href="/login" class="nav-btn login-btn">登入</a>
        {% endif %}
    </div>

    <!-- === 左上角 Logo === -->
    <header class="logo-container">
        <i class="fa-solid fa-hospital"></i>
        <span>醫資醫院</span>
    </header>

    <!-- === 主要內容 === -->
    <main class="main-container">
        <h1>請講出或輸入您的需求</h1>
        <textarea class="text-input" id="textInput" placeholder="請輸入文字或點擊麥克風錄音"></textarea>
        <button class="mic-button" id="micButton">
            <i class="fa-solid fa-microphone"></i>
        </button>
        <div class="recording-status" id="recordingStatus" style="display: none;">
            <i class="fa-solid fa-circle"></i>
            <span>正在錄音中...</span>
        </div>
        <div class="processing-status" id="processingStatus" style="display: none;">
            <i class="fa-solid fa-spinner fa-spin"></i>
            <span>正在處理音頻...</span>
        </div>
    </main>

    <script>
        const micButton = document.getElementById('micButton');
        const textInput = document.getElementById('textInput');
        const recordingStatus = document.getElementById('recordingStatus');
        const processingStatus = document.getElementById('processingStatus');
        
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        // 檢查瀏覽器是否支持錄音
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert('您的瀏覽器不支持錄音功能，請使用 Chrome、Edge 或 Firefox 瀏覽器');
        }

        micButton.addEventListener('click', async () => {
            if (!isRecording) {
                // 開始錄音
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream, {
                        mimeType: 'audio/webm;codecs=opus'
                    });
                    
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = async () => {
                        // 錄音結束，處理音頻
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        await sendAudioToServer(audioBlob);
                        
                        // 停止所有音頻軌道
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    micButton.classList.add('recording');
                    recordingStatus.style.display = 'flex';
                    
                } catch (error) {
                    console.error('無法訪問麥克風:', error);
                    alert('無法訪問麥克風，請確認已授予麥克風權限');
                }
            } else {
                // 停止錄音
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }
                isRecording = false;
                micButton.classList.remove('recording');
                recordingStatus.style.display = 'none';
                processingStatus.style.display = 'flex';
            }
        });

        async function sendAudioToServer(audioBlob) {
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');
                
                const response = await fetch('/api/transcribe', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 將轉錄的文字顯示在輸入面板中
                    const currentText = textInput.value.trim();
                    const newText = data.text;
                    
                    if (currentText) {
                        // 如果已有文字，在後面添加新文字
                        textInput.value = currentText + ' ' + newText;
                    } else {
                        // 如果沒有文字，直接顯示新文字
                        textInput.value = newText;
                    }
                } else {
                    alert('轉錄失敗: ' + (data.error || '未知錯誤'));
                }
            } catch (error) {
                console.error('發送音頻時發生錯誤:', error);
                alert('發送音頻時發生錯誤，請重試');
            } finally {
                processingStatus.style.display = 'none';
            }
        }
    </script>

</body>
</html>


