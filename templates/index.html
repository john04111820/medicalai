<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>語音助理介面</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>

    <!-- === 右上角導覽列 === -->
    <div class="top-right-nav">
        {% if username %}
            <!-- 有登入：顯示名字 + 預約連結 + 登出按鈕 -->
            <span class="user-welcome">嗨，{{ username }}</span>
            <a href="/appointment" class="nav-btn" style="background: #28a745; color: white; padding: 8px 15px; border-radius: 5px; text-decoration: none; margin-right: 10px;">
                <i class="fa-solid fa-calendar-plus"></i> 預約門診
            </a>
            <a href="/appointment/list" class="nav-btn" style="background: #17a2b8; color: white; padding: 8px 15px; border-radius: 5px; text-decoration: none; margin-right: 10px;">
                <i class="fa-solid fa-calendar-check"></i> 我的預約
            </a>
            <a href="/logout" class="nav-btn logout-btn">登出</a>
        {% else %}
            <!-- 沒登入：顯示登入按鈕，連結指向 /login -->
            <a href="/login" class="nav-btn login-btn">登入</a>
        {% endif %}
    </div>

    <!-- === 左上角 Logo === -->
    <a href="/" class="logo-container" title="返回首頁">
        <i class="fa-solid fa-hospital"></i>
        <span>醫資醫院</span>
    </a>

    <!-- === 主要內容 === -->
    <main class="main-container">
        <h1>醫療AI聊天助手</h1>
        
        <!-- 範例對話欄 -->
        <div class="example-bar">
            <div class="example-section">
                <div class="example-label">
                    <i class="fa-solid fa-calendar-check"></i>
                    <span>預約門診範例</span>
                </div>
                <div class="example-buttons">
                    <button class="example-btn appointment-info-btn" data-info-type="how-to-book">
                        <i class="fa-solid fa-stethoscope"></i> 如何預約門診？
                    </button>
                    <button class="example-btn appointment-info-btn" data-info-type="tomorrow-booking">
                        <i class="fa-solid fa-clock"></i> 預約明天門診
                    </button>
                    <button class="example-btn appointment-info-btn" data-info-type="preparation">
                        <i class="fa-solid fa-child"></i> 預約需要準備什麼？
                    </button>
                </div>
            </div>
            <div class="example-section">
                <div class="example-label">
                    <i class="fa-solid fa-heart-pulse"></i>
                    <span>常見疾病資訊</span>
                </div>
                <div class="example-buttons">
                    <button class="example-btn" data-example="感冒的症狀有哪些？該如何處理？">
                        <i class="fa-solid fa-head-side-cough"></i> 感冒症狀
                    </button>
                    <button class="example-btn" data-example="高血壓需要注意什麼？飲食上有什麼建議？">
                        <i class="fa-solid fa-heartbeat"></i> 高血壓注意事項
                    </button>
                    <button class="example-btn" data-example="頭痛可能是什麼原因？什麼時候需要看醫生？">
                        <i class="fa-solid fa-head-side-virus"></i> 頭痛原因
                    </button>
                    <button class="example-btn" data-example="胃痛該如何緩解？什麼情況下需要就醫？">
                        <i class="fa-solid fa-stomach"></i> 胃痛處理
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 聊天消息顯示區域 -->
        <div class="chat-container" id="chatContainer">
            <div class="welcome-message">
                <i class="fa-solid fa-robot"></i>
                <p>您好！我是醫療AI助手，專注於提供醫療相關的諮詢服務。我可以幫助您解答症狀評估、疾病資訊、用藥注意事項等醫療問題。如需預約門診，請點擊右上角的「預約門診」按鈕。您可以輸入文字或使用語音輸入與我對話。</p>
            </div>
        </div>
        
        <!-- 輸入區域 -->
        <div class="input-container">
            <div class="input-wrapper">
                <textarea class="text-input" id="textInput" placeholder="請輸入您的問題或點擊麥克風錄音..." rows="2"></textarea>
                <div class="input-buttons">
                    <button class="mic-button" id="micButton" title="語音輸入">
                        <i class="fa-solid fa-microphone"></i>
                    </button>
                    <button class="send-button" id="sendButton" title="發送">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                    <button class="clear-button" id="clearButton" title="清除對話">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="recording-status" id="recordingStatus" style="display: none;">
                <i class="fa-solid fa-circle"></i>
                <span>正在錄音中...</span>
            </div>
            <div class="processing-status" id="processingStatus" style="display: none;">
                <i class="fa-solid fa-spinner fa-spin"></i>
                <span id="processingText">正在處理...</span>
            </div>
        </div>
    </main>

    <!-- === 預約表單彈窗 === -->
    <div id="appointmentModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:999; align-items:center; justify-content:center;">
        <div style="background:white; width:90%; max-width:640px; border-radius:10px; padding:24px; position:relative; max-height:90vh; overflow:auto;">
            <button id="closeModalBtn" style="position:absolute; right:12px; top:12px; border:none; background:transparent; font-size:18px; cursor:pointer;">✕</button>
            <h2 style="margin-top:0; color:#5563DE;">快速預約</h2>
            <form id="modalAppointmentForm">
                <div class="form-group">
                    <label>病歷號（選填）</label>
                    <input type="text" name="patient_id" placeholder="如：P12345">
                </div>
                <div class="form-group">
                    <label>病患姓名 <span class="required" style="color:red">*</span></label>
                    <input type="text" name="patient_name" required placeholder="請輸入病患姓名">
                </div>
                <div class="form-group">
                    <label>聯絡電話 <span class="required" style="color:red">*</span></label>
                    <input type="tel" name="patient_phone" required placeholder="請輸入聯絡電話">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>科別 <span class="required" style="color:red">*</span></label>
                        <select name="department" id="modalDepartment" required>
                            <option value="">請選擇科別</option>
                            <option value="內科">內科</option>
                            <option value="外科">外科</option>
                            <option value="兒科">兒科</option>
                            <option value="婦產科">婦產科</option>
                            <option value="骨科">骨科</option>
                            <option value="眼科">眼科</option>
                            <option value="耳鼻喉科">耳鼻喉科</option>
                            <option value="皮膚科">皮膚科</option>
                            <option value="精神科">精神科</option>
                            <option value="復健科">復健科</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>醫師姓名 <span class="required" style="color:red">*</span></label>
                        <select name="doctor_name" id="modalDoctor" required>
                            <option value="">請先選擇科別</option>
                        </select>
                        <small style="color:#6c757d;">早班 09:00-15:00／午班 15:00-21:00</small>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>預約日期 <span class="required" style="color:red">*</span></label>
                        <input type="date" name="appointment_date" id="modalDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>症狀描述（選填）</label>
                    <textarea name="symptoms" rows="3" placeholder="簡述症狀、需求"></textarea>
                </div>
                <div class="btn-group" style="margin-top:12px;">
                    <button type="submit" class="btn btn-primary" style="flex:1;">提交預約</button>
                    <button type="button" id="cancelModalBtn" class="btn btn-secondary" style="flex:1;">取消</button>
                </div>
            </form>
        </div>
    </div>

    <!-- === 醫師時刻表彈窗 === -->
    <div id="scheduleModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:999; align-items:center; justify-content:center;">
        <div style="background:white; width:90%; max-width:520px; border-radius:10px; padding:22px; position:relative; max-height:90vh; overflow:auto;">
            <button id="closeScheduleBtn" style="position:absolute; right:12px; top:12px; border:none; background:transparent; font-size:18px; cursor:pointer;">✕</button>
            <h2 id="scheduleTitle" style="margin-top:0; color:#5563DE;">醫師時刻表</h2>
            <div id="scheduleBody"></div>
        </div>
    </div>

    <script>
        const micButton = document.getElementById('micButton');
        const textInput = document.getElementById('textInput');
        const sendButton = document.getElementById('sendButton');
        const clearButton = document.getElementById('clearButton');
        const chatContainer = document.getElementById('chatContainer');
        const recordingStatus = document.getElementById('recordingStatus');
        const processingStatus = document.getElementById('processingStatus');
        const processingText = document.getElementById('processingText');
        
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let isLoadingHistory = false; // 標記是否正在載入歷史記錄


        // 檢查瀏覽器是否支持錄音
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert('您的瀏覽器不支持錄音功能，請使用 Chrome、Edge 或 Firefox 瀏覽器');
        }

        // 發送消息按鈕事件
        sendButton.addEventListener('click', sendMessage);
        
        // 按 Enter 發送（Shift+Enter 換行）
        textInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // 清除對話歷史
        clearButton.addEventListener('click', async () => {
            if (confirm('確定要清除所有對話記錄嗎？')) {
                try {
                    const response = await fetch('/api/clear-history', {
                        method: 'POST'
                    });
                    const data = await response.json();
                    if (data.success) {
                        // 清除 localStorage
                        localStorage.removeItem('chatHistory');
                        chatContainer.innerHTML = `
                            <div class="welcome-message">
                                <i class="fa-solid fa-robot"></i>
                                <p>您好！我是醫療AI助手，專注於提供醫療相關的諮詢服務。我可以幫助您解答症狀評估、疾病資訊、用藥注意事項等醫療問題。如需預約門診，請點擊右上角的「預約門診」按鈕。您可以輸入文字或使用語音輸入與我對話。</p>
                            </div>
                        `;
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }
                } catch (error) {
                    console.error('清除對話歷史失敗:', error);
                }
            }
        });

        // 頁面載入時恢復對話記錄
        window.addEventListener('DOMContentLoaded', () => {
            loadChatHistory();
        });

        micButton.addEventListener('click', async () => {
            if (!isRecording) {
                // 開始錄音
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream, {
                        mimeType: 'audio/webm;codecs=opus'
                    });
                    
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = async () => {
                        // 錄音結束，處理音頻
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        await sendAudioToServer(audioBlob);
                        
                        // 停止所有音頻軌道
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    micButton.classList.add('recording');
                    recordingStatus.style.display = 'flex';
                    
                } catch (error) {
                    console.error('無法訪問麥克風:', error);
                    alert('無法訪問麥克風，請確認已授予麥克風權限');
                }
            } else {
                // 停止錄音
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }
                isRecording = false;
                micButton.classList.remove('recording');
                recordingStatus.style.display = 'none';
                processingStatus.style.display = 'flex';
            }
        });

        async function sendAudioToServer(audioBlob) {
            try {
                console.log('開始發送音頻，大小:', audioBlob.size, 'bytes');
                
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');
                
                const response = await fetch('/api/transcribe', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('收到響應，狀態:', response.status);
                
                // 檢查響應狀態
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('服務器錯誤:', errorText);
                    throw new Error(`服務器錯誤: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                console.log('收到數據:', data);
                
                if (data.success && data.text) {
                    const newText = data.text.trim();
                    
                    if (newText) {
                        // 將轉錄的文字顯示在輸入框中
                        textInput.value = newText;
                        console.log('語音轉文字成功，文字已填入輸入框');
                        // 自動發送消息到 Gemini
                        await sendMessage();
                    } else {
                        console.warn('轉錄結果為空');
                        alert('未能識別到語音內容，請重試');
                    }
                } else {
                    const errorMsg = data.error || '未知錯誤';
                    console.error('轉錄失敗:', errorMsg);
                    alert('轉錄失敗: ' + errorMsg);
                }
            } catch (error) {
                console.error('發送音頻時發生錯誤:', error);
                alert('發送音頻時發生錯誤: ' + error.message + '\n請查看瀏覽器控制台獲取詳細信息');
            } finally {
                processingStatus.style.display = 'none';
            }
        }

        // 預約/時刻表 關鍵字偵測
        const createKeywords = ['預約', '掛號', '我要預約', '幫我預約', '預約門診', '我要掛號'];
        const scheduleKeywords = ['時間', '時段', '門診', '上班', '看診', '時刻表'];

        // 發送消息到 Gemini（若判定為預約/時刻表意圖，彈出對應表單）
        async function sendMessage() {
            const message = textInput.value.trim();
            if (!message) return;

            // 檢查是否詢問時刻表
            const deptList = Object.keys(doctorOptions || {});
            const matchedDept = deptList.find(dept => message.includes(dept));
            const isScheduleIntent = matchedDept && scheduleKeywords.some(k => message.includes(k));
            if (isScheduleIntent) {
                openScheduleModal(matchedDept);
                return;
            }

            const isCreateIntent = createKeywords.some(k => message.includes(k));
            if (isCreateIntent) {
                openAppointmentModal();
                return;
            }
            
            // 顯示用戶消息
            addMessageToChat('user', message);
            
            // 清空輸入框
            textInput.value = '';
            
            // 顯示 AI 正在輸入
            const aiMessageElement = addMessageToChat('assistant', '正在思考...', true);
            
            // 禁用輸入
            textInput.disabled = true;
            sendButton.disabled = true;
            micButton.disabled = true;
            processingText.textContent = 'AI 正在回應...';
            processingStatus.style.display = 'flex';
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: message })
                });
                
                const data = await response.json();
                
                // 移除「正在思考...」消息
                aiMessageElement.remove();
                
                if (data.success && data.message) {
                    // 顯示 AI 回應
                    addMessageToChat('assistant', data.message);
                } else {
                    const errorMsg = data.error || '未知錯誤';
                    addMessageToChat('assistant', '抱歉，發生錯誤：' + errorMsg);
                    console.error('Gemini API 錯誤:', errorMsg);
                }
            } catch (error) {
                // 移除「正在思考...」消息
                aiMessageElement.remove();
                addMessageToChat('assistant', '抱歉，發送消息時發生錯誤，請重試。');
                console.error('發送消息錯誤:', error);
            } finally {
                // 恢復輸入
                textInput.disabled = false;
                sendButton.disabled = false;
                micButton.disabled = false;
                processingStatus.style.display = 'none';
                textInput.focus();
            }
        }

        // 保存對話記錄到 localStorage
        function saveChatHistory() {
            // 如果正在載入歷史記錄，不保存
            if (isLoadingHistory) {
                return;
            }
            
            const messages = [];
            const messageElements = chatContainer.querySelectorAll('.message');
            messageElements.forEach(msg => {
                const role = msg.classList.contains('user-message') ? 'user' : 'assistant';
                const contentElement = msg.querySelector('.message-text');
                if (contentElement && !contentElement.querySelector('.typing-indicator')) {
                    const content = contentElement.textContent || contentElement.innerText;
                    const timeElement = msg.querySelector('.message-time');
                    const time = timeElement ? timeElement.textContent : getCurrentTime();
                    messages.push({ role, content, time });
                }
            });
            localStorage.setItem('chatHistory', JSON.stringify(messages));
        }

        // 從 localStorage 載入對話記錄
        function loadChatHistory() {
            // 檢查頁面上是否已經有消息（除了歡迎消息）
            const existingMessages = chatContainer.querySelectorAll('.message');
            if (existingMessages.length > 0) {
                // 如果已經有消息，不載入（避免重複）
                return false;
            }
            
            try {
                isLoadingHistory = true; // 設置載入標記
                
                const savedHistory = localStorage.getItem('chatHistory');
                if (savedHistory) {
                    const messages = JSON.parse(savedHistory);
                    if (messages && messages.length > 0) {
                        // 移除歡迎消息
                        const welcomeMsg = chatContainer.querySelector('.welcome-message');
                        if (welcomeMsg) {
                            welcomeMsg.remove();
                        }
                        // 恢復所有消息（不觸發保存）
                        messages.forEach(msg => {
                            addMessageToChat(msg.role, msg.content, false, msg.time, true);
                        });
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                        return true;
                    }
                }
            } catch (error) {
                console.error('載入對話記錄失敗:', error);
            } finally {
                isLoadingHistory = false; // 清除載入標記
            }
            return false;
        }

        // 添加消息到聊天界面
        function addMessageToChat(role, content, isTyping = false, customTime = null, skipSave = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message`;
            
            const messageTime = customTime || getCurrentTime();
            
            if (role === 'user') {
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <div class="message-text">${escapeHtml(content)}</div>
                        <div class="message-time">${messageTime}</div>
                    </div>
                    <div class="message-avatar">
                        <i class="fa-solid fa-user"></i>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-avatar">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-text">${isTyping ? '<span class="typing-indicator">正在輸入...</span>' : escapeHtml(content)}</div>
                        <div class="message-time">${messageTime}</div>
                    </div>
                `;
            }
            
            // 移除歡迎消息（如果存在）
            const welcomeMsg = chatContainer.querySelector('.welcome-message');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // 如果不是正在輸入的臨時消息，且不是載入歷史記錄時，保存對話記錄
            if (!isTyping && !skipSave && !isLoadingHistory) {
                saveChatHistory();
            }
            
            return messageDiv;
        }

        // HTML 轉義函數
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 獲取當前時間
        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
        }

        // 預約門診說明內容
        const appointmentInfoContent = {
            'how-to-book': `**如何預約門診？**

預約門診非常簡單，您可以透過以下方式：

**方式一：使用預約表單**
1. 點擊右上角的「預約門診」按鈕
2. 填寫完整的預約資訊：
   - 病患姓名（必填）
   - 聯絡電話（必填）
   - 選擇科別（必填）
   - 選擇醫師（必填）
   - 選擇預約日期（必填，需為明天之後）
   - 病歷號和症狀描述（選填）
3. 點擊「提交預約」完成預約

**方式二：透過 AI 聊天**
1. 在聊天框中輸入「我要預約」或「我要掛號」
2. 系統會自動彈出預約表單
3. 填寫資訊後即可完成預約

**營業時間**
• 早班：09:00 - 15:00
• 午班：15:00 - 21:00
• 預約時間需在營業時間內

**注意事項**
• 預約日期必須是明天之後的日期
• 每個科別都有早班和午班兩位醫師可選擇
• 預約成功後可在「我的預約」頁面查看和管理`,

            'tomorrow-booking': `**預約明天門診**

**預約步驟：**
1. 點擊右上角「預約門診」按鈕
2. 在預約日期欄位選擇「明天」的日期
3. 選擇科別和醫師
4. 選擇時間（09:00-21:00）
5. 填寫其他必要資訊
6. 提交預約

**可預約時段：**
• **早班時段**：09:00 - 15:00
• **午班時段**：15:00 - 21:00

**提醒事項：**
• 預約時間必須在醫師的上班時段內
• 建議提前預約，確保有合適的時段
• 預約成功後會收到確認訊息
• 可在「我的預約」頁面查看預約詳情

**快速預約**
您也可以直接在聊天框輸入「我要預約明天內科門診」，系統會自動為您開啟預約表單。`,

            'preparation': `**預約需要準備什麼？**

預約門診前，請準備以下資訊：

**必備資訊：**
1. **病患姓名**：請填寫真實姓名
2. **聯絡電話**：用於預約確認和通知
3. **科別**：選擇要就診的科別
   - 內科、外科、兒科、婦產科、骨科
   - 眼科、耳鼻喉科、皮膚科、精神科、復健科
4. **醫師**：選擇該科別的醫師（早班或午班）
5. **預約日期**：選擇明天之後的日期
6. **預約時間**：選擇 09:00-21:00 之間的時段

**選填資訊：**
• **病歷號**：如有病歷號可填寫，無則可留空
• **症狀描述**：簡述主要症狀，幫助醫師準備

**其他準備事項：**
• 確認預約日期和時間是否方便
• 如需取消或修改預約，可在「我的預約」頁面操作
• 建議提前 10-15 分鐘到達醫院
• 記得攜帶身份證件和健保卡（如適用）

**注意事項：**
• 預約時間需在醫師的上班時段內
• 每個科別有早班（09:00-15:00）和午班（15:00-21:00）可選擇
• 預約成功後請妥善保存預約資訊`
        };

        // 預約門診說明按鈕點擊事件
        document.querySelectorAll('.appointment-info-btn').forEach(button => {
            button.addEventListener('click', function() {
                const infoType = this.getAttribute('data-info-type');
                const content = appointmentInfoContent[infoType];
                if (content) {
                    // 顯示說明內容到聊天容器
                    addMessageToChat('assistant', content);
                }
            });
        });

        // 其他範例對話按鈕點擊事件（常見疾病資訊）
        document.querySelectorAll('.example-btn:not(.appointment-info-btn)').forEach(button => {
            button.addEventListener('click', function() {
                const exampleText = this.getAttribute('data-example');
                if (exampleText) {
                    textInput.value = exampleText;
                    sendMessage();
                }
            });
        });

        // ===== 預約表單彈窗邏輯 =====
        const appointmentModal = document.getElementById('appointmentModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelModalBtn = document.getElementById('cancelModalBtn');
        const modalForm = document.getElementById('modalAppointmentForm');
        const modalDept = document.getElementById('modalDepartment');
        const modalDoctor = document.getElementById('modalDoctor');
        const doctorOptions = JSON.parse('{{ doctor_options|tojson|safe }}');
        const scheduleModal = document.getElementById('scheduleModal');
        const closeScheduleBtn = document.getElementById('closeScheduleBtn');
        const scheduleTitle = document.getElementById('scheduleTitle');
        const scheduleBody = document.getElementById('scheduleBody');

        function openAppointmentModal() {
            appointmentModal.style.display = 'flex';
        }
        function closeAppointmentModal() {
            appointmentModal.style.display = 'none';
        }

        function populateModalDoctors(dept, preset) {
            modalDoctor.innerHTML = '<option value="">' + '請選擇醫師' + '</option>';
            const list = doctorOptions[dept] || [];
            list.forEach(item => {
                const shiftLabel = item.shift === 'morning' ? '早班 09:00-15:00' : '午班 15:00-21:00';
                const opt = document.createElement('option');
                opt.value = item.doctor_name;
                opt.textContent = `${item.doctor_name}（${shiftLabel}）`;
                if (preset && preset === item.doctor_name) opt.selected = true;
                modalDoctor.appendChild(opt);
            });
        }
        modalDept.addEventListener('change', (e) => {
            populateModalDoctors(e.target.value, null);
        });

        closeModalBtn.addEventListener('click', closeAppointmentModal);
        cancelModalBtn.addEventListener('click', closeAppointmentModal);
        appointmentModal.addEventListener('click', (e) => {
            if (e.target === appointmentModal) closeAppointmentModal();
        });

        // 時刻表
        function openScheduleModal(dept) {
            const list = doctorOptions[dept] || [];
            scheduleTitle.textContent = `${dept} — 醫師時刻表`;
            if (!list.length) {
                scheduleBody.innerHTML = '<p style="color:#666;">目前沒有該科別的醫師資料。</p>';
            } else {
                const rows = list.map(item => {
                    const shiftLabel = item.shift === 'morning' ? '早班 09:00-15:00' : '午班 15:00-21:00';
                    return `<div style="padding:10px 0; border-bottom:1px solid #eee;">
                        <div style="font-weight:600;">${item.doctor_name}</div>
                        <div style="color:#555;">${shiftLabel}</div>
                    </div>`;
                }).join('');
                scheduleBody.innerHTML = rows;
            }
            scheduleModal.style.display = 'flex';
        }
        function closeScheduleModal() { scheduleModal.style.display = 'none'; }
        closeScheduleBtn.addEventListener('click', closeScheduleModal);
        scheduleModal.addEventListener('click', (e) => {
            if (e.target === scheduleModal) closeScheduleModal();
        });

        // 設置最小日期（明天）
        const modalDate = document.getElementById('modalDate');
        const modalTomorrow = new Date();
        modalTomorrow.setDate(modalTomorrow.getDate() + 1);
        modalDate.min = modalTomorrow.toISOString().split('T')[0];

        // 表單提交：直接 POST 到 /appointment，成功後導向預約列表
        modalForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(modalForm);
            try {
                const response = await fetch('/appointment', { method: 'POST', body: formData });
                if (response.redirected) {
                    window.location = response.url;
                    return;
                }
                const text = await response.text();
                if ((response.ok && text.includes('我的預約')) || text.includes('預約記錄')) {
                    window.location = '/appointment/list';
                } else {
                    alert('提交可能失敗，請確認表單或稍後再試');
                }
            } catch (err) {
                console.error('預約提交失敗:', err);
                alert('預約提交失敗，請稍後再試');
            }
        });

        // 快捷鍵：輸入框內 Ctrl/Cmd+Enter 也觸發送出
        textInput.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });

        // 頁面載入完成後恢復對話記錄
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadChatHistory);
        } else {
            loadChatHistory();
        }
    </script>

</body>
</html>


