<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>語音助理介面</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>

    <!-- === 右上角導覽列 === -->
    <div class="top-right-nav">
        {% if username %}
            <!-- 有登入：顯示名字 + 預約連結 + 登出按鈕 -->
            <span class="user-welcome">嗨，{{ username }}</span>
            <a href="/appointment" class="nav-btn" style="background: #28a745; color: white; padding: 8px 15px; border-radius: 5px; text-decoration: none; margin-right: 10px;">
                <i class="fa-solid fa-calendar-plus"></i> 預約門診
            </a>
            <a href="/appointment/list" class="nav-btn" style="background: #17a2b8; color: white; padding: 8px 15px; border-radius: 5px; text-decoration: none; margin-right: 10px;">
                <i class="fa-solid fa-calendar-check"></i> 我的預約
            </a>
            <a href="/logout" class="nav-btn logout-btn">登出</a>
        {% else %}
            <!-- 沒登入：顯示登入按鈕，連結指向 /login -->
            <a href="/login" class="nav-btn login-btn">登入</a>
        {% endif %}
    </div>

    <!-- === 左上角 Logo === -->
    <header class="logo-container">
        <i class="fa-solid fa-hospital"></i>
        <span>醫資醫院</span>
    </header>

    <!-- === 主要內容 === -->
    <main class="main-container">
        <h1>醫療AI聊天助手</h1>
        
        <!-- 聊天消息顯示區域 -->
        <div class="chat-container" id="chatContainer">
            <div class="welcome-message">
                <i class="fa-solid fa-robot"></i>
                <p>您好！我是醫療AI助手，可以幫助您解答醫療相關問題。您可以輸入文字或使用語音輸入。</p>
            </div>
        </div>
        
        <!-- 輸入區域 -->
        <div class="input-container">
            <div class="input-wrapper">
                <textarea class="text-input" id="textInput" placeholder="請輸入您的問題或點擊麥克風錄音..." rows="2"></textarea>
                <div class="input-buttons">
                    <button class="mic-button" id="micButton" title="語音輸入">
                        <i class="fa-solid fa-microphone"></i>
                    </button>
                    <button class="send-button" id="sendButton" title="發送">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                    <button class="clear-button" id="clearButton" title="清除對話">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="recording-status" id="recordingStatus" style="display: none;">
                <i class="fa-solid fa-circle"></i>
                <span>正在錄音中...</span>
            </div>
            <div class="processing-status" id="processingStatus" style="display: none;">
                <i class="fa-solid fa-spinner fa-spin"></i>
                <span id="processingText">正在處理...</span>
            </div>
        </div>
    </main>

    <script>
        const micButton = document.getElementById('micButton');
        const textInput = document.getElementById('textInput');
        const sendButton = document.getElementById('sendButton');
        const clearButton = document.getElementById('clearButton');
        const chatContainer = document.getElementById('chatContainer');
        const recordingStatus = document.getElementById('recordingStatus');
        const processingStatus = document.getElementById('processingStatus');
        const processingText = document.getElementById('processingText');
        
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        // 檢查瀏覽器是否支持錄音
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert('您的瀏覽器不支持錄音功能，請使用 Chrome、Edge 或 Firefox 瀏覽器');
        }

        // 發送消息按鈕事件
        sendButton.addEventListener('click', sendMessage);
        
        // 按 Enter 發送（Shift+Enter 換行）
        textInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // 清除對話歷史
        clearButton.addEventListener('click', async () => {
            if (confirm('確定要清除所有對話記錄嗎？')) {
                try {
                    const response = await fetch('/api/clear-history', {
                        method: 'POST'
                    });
                    const data = await response.json();
                    if (data.success) {
                        chatContainer.innerHTML = `
                            <div class="welcome-message">
                                <i class="fa-solid fa-robot"></i>
                                <p>您好！我是醫療AI助手，可以幫助您解答醫療相關問題。您可以輸入文字或使用語音輸入。</p>
                            </div>
                        `;
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }
                } catch (error) {
                    console.error('清除對話歷史失敗:', error);
                }
            }
        });

        micButton.addEventListener('click', async () => {
            if (!isRecording) {
                // 開始錄音
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream, {
                        mimeType: 'audio/webm;codecs=opus'
                    });
                    
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = async () => {
                        // 錄音結束，處理音頻
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        await sendAudioToServer(audioBlob);
                        
                        // 停止所有音頻軌道
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    micButton.classList.add('recording');
                    recordingStatus.style.display = 'flex';
                    
                } catch (error) {
                    console.error('無法訪問麥克風:', error);
                    alert('無法訪問麥克風，請確認已授予麥克風權限');
                }
            } else {
                // 停止錄音
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }
                isRecording = false;
                micButton.classList.remove('recording');
                recordingStatus.style.display = 'none';
                processingStatus.style.display = 'flex';
            }
        });

        async function sendAudioToServer(audioBlob) {
            try {
                console.log('開始發送音頻，大小:', audioBlob.size, 'bytes');
                
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');
                
                const response = await fetch('/api/transcribe', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('收到響應，狀態:', response.status);
                
                // 檢查響應狀態
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('服務器錯誤:', errorText);
                    throw new Error(`服務器錯誤: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                console.log('收到數據:', data);
                
                if (data.success && data.text) {
                    const newText = data.text.trim();
                    
                    if (newText) {
                        // 將轉錄的文字顯示在輸入框中
                        textInput.value = newText;
                        console.log('語音轉文字成功，文字已填入輸入框');
                        // 自動發送消息到 Gemini
                        await sendMessage();
                    } else {
                        console.warn('轉錄結果為空');
                        alert('未能識別到語音內容，請重試');
                    }
                } else {
                    const errorMsg = data.error || '未知錯誤';
                    console.error('轉錄失敗:', errorMsg);
                    alert('轉錄失敗: ' + errorMsg);
                }
            } catch (error) {
                console.error('發送音頻時發生錯誤:', error);
                alert('發送音頻時發生錯誤: ' + error.message + '\n請查看瀏覽器控制台獲取詳細信息');
            } finally {
                processingStatus.style.display = 'none';
            }
        }

        // 發送消息到 Gemini
        async function sendMessage() {
            const message = textInput.value.trim();
            
            if (!message) {
                return;
            }
            
            // 顯示用戶消息
            addMessageToChat('user', message);
            
            // 清空輸入框
            textInput.value = '';
            
            // 顯示 AI 正在輸入
            const aiMessageElement = addMessageToChat('assistant', '正在思考...', true);
            
            // 禁用輸入
            textInput.disabled = true;
            sendButton.disabled = true;
            micButton.disabled = true;
            processingText.textContent = 'AI 正在回應...';
            processingStatus.style.display = 'flex';
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: message })
                });
                
                const data = await response.json();
                
                // 移除「正在思考...」消息
                aiMessageElement.remove();
                
                if (data.success && data.message) {
                    // 顯示 AI 回應
                    addMessageToChat('assistant', data.message);
                } else {
                    const errorMsg = data.error || '未知錯誤';
                    addMessageToChat('assistant', '抱歉，發生錯誤：' + errorMsg);
                    console.error('Gemini API 錯誤:', errorMsg);
                }
            } catch (error) {
                // 移除「正在思考...」消息
                aiMessageElement.remove();
                addMessageToChat('assistant', '抱歉，發送消息時發生錯誤，請重試。');
                console.error('發送消息錯誤:', error);
            } finally {
                // 恢復輸入
                textInput.disabled = false;
                sendButton.disabled = false;
                micButton.disabled = false;
                processingStatus.style.display = 'none';
                textInput.focus();
            }
        }

        // 添加消息到聊天界面
        function addMessageToChat(role, content, isTyping = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message`;
            
            if (role === 'user') {
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <div class="message-text">${escapeHtml(content)}</div>
                        <div class="message-time">${getCurrentTime()}</div>
                    </div>
                    <div class="message-avatar">
                        <i class="fa-solid fa-user"></i>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-avatar">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-text">${isTyping ? '<span class="typing-indicator">正在輸入...</span>' : escapeHtml(content)}</div>
                        <div class="message-time">${getCurrentTime()}</div>
                    </div>
                `;
            }
            
            // 移除歡迎消息（如果存在）
            const welcomeMsg = chatContainer.querySelector('.welcome-message');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            return messageDiv;
        }

        // HTML 轉義函數
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 獲取當前時間
        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
        }
    </script>

</body>
</html>


