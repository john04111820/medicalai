# 資料庫寫入問題診斷指南

## 快速診斷步驟

### 步驟 1：運行測試工具

執行以下命令來測試資料庫寫入功能：

```bash
python 測試資料庫寫入.py
```

這個工具會：
- ✅ 測試資料庫連接
- ✅ 檢查資料表是否存在
- ✅ 測試資料寫入功能
- ✅ 驗證資料是否成功保存
- ✅ 檢查資料庫權限

### 步驟 2：檢查常見問題

#### 問題 1：資料庫連接失敗

**症狀：**
```
❌ 資料庫連接失敗: (2003, "Can't connect to MySQL server...")
```

**解決方法：**
1. 確認 MySQL 服務正在運行
   - Windows: 打開「服務」，確認 MySQL 服務狀態為「正在運行」
   - 或使用命令：`net start MySQL`（管理員權限）

2. 檢查 .env 文件配置
   ```env
   DB_HOST=localhost
   DB_USER=root
   DB_PASSWORD=您的密碼
   DB_NAME=medical_db
   ```

#### 問題 2：資料表不存在

**症狀：**
```
❌ 資料表 'medical_appointments' 不存在
```

**解決方法：**
1. 重新啟動應用程式，它會自動創建資料表
2. 或手動執行 SQL：
   ```sql
   USE medical_db;
   CREATE TABLE IF NOT EXISTS medical_appointments (
       id INT AUTO_INCREMENT PRIMARY KEY,
       username VARCHAR(100) NOT NULL,
       patient_name VARCHAR(100) NOT NULL,
       patient_phone VARCHAR(20) NOT NULL,
       department VARCHAR(100) NOT NULL,
       doctor_name VARCHAR(100) NOT NULL,
       appointment_date DATE NOT NULL,
       appointment_time TIME NOT NULL,
       symptoms TEXT,
       status VARCHAR(20) DEFAULT 'pending',
       created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
       updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
       INDEX idx_username (username),
       INDEX idx_appointment_date (appointment_date)
   ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
   ```

#### 問題 3：權限不足

**症狀：**
```
❌ 資料庫錯誤: (1142, "INSERT command denied to user...")
```

**解決方法：**
授予使用者 INSERT 權限：
```sql
GRANT INSERT, SELECT, UPDATE, DELETE ON medical_db.* TO 'root'@'localhost';
FLUSH PRIVILEGES;
```

#### 問題 4：資料庫不存在

**症狀：**
```
❌ 資料庫錯誤: (1049, "Unknown database 'medical_db'")
```

**解決方法：**
創建資料庫：
```sql
CREATE DATABASE medical_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

#### 問題 5：認證失敗

**症狀：**
```
❌ 資料庫錯誤: (1045, "Access denied for user...")
```

**解決方法：**
1. 確認 .env 文件中的密碼正確
2. 確認使用者名稱正確
3. 測試 MySQL 登入：
   ```bash
   mysql -u root -p
   ```

### 步驟 3：檢查應用程式日誌

當您嘗試創建預約時，查看應用程式的日誌輸出：

**成功的情況：**
```
[預約] 開始寫入資料庫 - 用戶: admin, 病患: 張三, 科別: 內科...
[成功] 預約資料已成功寫入資料庫，預約ID: 1
[驗證] 資料已確認存在於資料庫中
```

**失敗的情況：**
```
[錯誤] 預約寫入資料庫失敗
[錯誤代碼] 1146
[錯誤訊息] Table 'medical_db.medical_appointments' doesn't exist
```

### 步驟 4：手動驗證資料

登入 MySQL 並檢查資料：

```sql
USE medical_db;
SELECT * FROM medical_appointments;
```

如果看到您的預約記錄，表示寫入成功。

## 改進的錯誤處理

應用程式現在會：

1. **提供更詳細的錯誤訊息**
   - 顯示錯誤代碼
   - 顯示具體的錯誤訊息
   - 根據錯誤類型提供解決建議

2. **驗證資料寫入**
   - 寫入後立即驗證資料是否存在
   - 如果驗證失敗，會回滾並報告錯誤

3. **記錄詳細日誌**
   - 記錄所有寫入操作
   - 記錄錯誤詳情
   - 方便問題診斷

## 需要更多幫助？

如果以上方法都無法解決問題：

1. 執行 `python 測試資料庫寫入.py` 查看詳細診斷
2. 執行 `python 檢查預約功能.py` 檢查整體配置
3. 查看應用程式啟動時的完整日誌
4. 檢查 MySQL 錯誤日誌（通常在 MySQL 安裝目錄的 data 資料夾中）

